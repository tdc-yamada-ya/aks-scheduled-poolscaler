# AKS ノードプールスケーラー

[AKS] のノードプールを休日や祝日のようなイベント日、時間帯に合わせてスケール調整するためのコマンドラインツールです。

[EKS] における
[Scheduled scaling for Amazon EC2 Auto Scaling](https://docs.aws.amazon.com/autoscaling/ec2/userguide/schedule_time.html)
を [AKS] で実現するためのプロダクトです。

休日や何らかのイベント日において必要とする資源が大きく変動する場合、
[AKS] に備わっている標準的な自動スケーリングでは拡張が間に合わない可能性があります。
このプロダクトを使うことであらかじめ時期ごとに必要な資源が分かっているクラスタにおいて、
事前にスケールを済ませておくことができます。

このプロダクトは Kubernetes の CronJob で定期的に実行されることを前提としています。

このプロダクトには cron ライクなフォーマットでスケジュールを設定することができます。
現在時刻にマッチするルールを見つけたときに以下の設定をノードプールに反映します。

- オートスケーリングの有効・無効
- ノード数 (オートスケーリングが無効の場合のみ)
- 最小ノード数 (オートスケーリングが有効の場合のみ)
- 最大ノード数 (オートスケーリングが有効の場合のみ)

## AKS へのデプロイ

[docs/deploy-to-aks.md](docs/deploy-to-aks.md) を参照してください。

[aks]: https://azure.microsoft.com/services/kubernetes-service/
[eks]: https://aws.amazon.com/eks/

## 設定ファイル

このプロダクトの設定ファイルには以下の内容を記載します。

- ノードプールの設定パラメータのリスト
- パラメータを変更する AKS リソースのリスト
- パラメータを変更する時間的条件
- 条件成立時に使用するパラメータの名前

```yaml
# ノードプールの設定パラメータのリストを設定します。
paramsDefs:
  few: # 設定パラメータの名前
    enableAutoScaling: false # オートスケーリングの有効・無効
    count: 1 # ノード数 (オートスケーリングが無効の場合のみ)
  normal:
    enableAutoScaling: false
    count: 2
  many:
    enableAutoScaling: true
    minCount: 2 # 最小ノード数 (オートスケーリングが有効の場合のみ)
    maxCount: 4 # 最大ノード数 (オートスケーリングが有効の場合のみ)

# パラメータを変更する AKS リソースのリストを設定します。
resources:
  - resourceGroupName: "resourceGroupName" # リソースグループ名
    resourceName: "resourceName" # リソース名
    agentPoolName: "agentPoolName" # プール名
    rules:
      - expr: "* * * * * Fri" # 時間的条件式 (後述)
        paramsRef: few # 使用するパラメータ名
      - expr: "* * * * * *"
        paramsRef: normal
```

なお各リソースに定義するルールリストは、上から順番に条件を評価していき、
一番最初に条件を満たしたもののパラメータを設定します。

### 時間的条件式

この条件式は cron に似ています。
書式は以下の通りです。

```
+------------ 分 (0 - 59)
| +---------- 時 (0 - 23)
| | +-------- 日 (1 - 31)
| | | +------ 月 (1 - 12 あるいは Jan, Feb, ..., Dec)
| | | | +---- 年 (1 - )
| | | | | +-- 曜日 (0 - 6 あるいは Sun, Mon, ..., Sat) (日曜日=0)
| | | | | |
* * * * * *
```

各要素のパターンは以下の通りです。

- `*` 全てにマッチ
- `10` 10 の時だけにマッチ
- `10-` 10 以上にマッチ
- `-10` 10 以下にマッチ
- `10-20` 10 以上 20 以下にマッチ
- `10,20` 10 と 20 にマッチ

`* * * * * *` を指定すると全ての時刻にマッチするため、デフォルト値の設定に使うことができます。
